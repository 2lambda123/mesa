<!DOCTYPE html>
<head>
	<title>{{ model_name }} (Mesa visualization)</title>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="/static/dat.gui.min.js"></script>
	<script>

		var MesaVisualizationControl = function() {
			this.tick = -1; // Counts at which tick of the model we are.
			this.running = false; // Whether there is currently a model running
			this.fps  = 3 ; // Frames per second
		}

		var player; // Variable to store the continuous player
		var control = new MesaVisualizationControl();

		// WebSocket Stuff
		var ws = new WebSocket("ws://127.0.0.1:{{ port }}/ws");
		ws.onopen = function() {console.log("Connection opened!"); };

		ws.onmessage = function(message) {
			msg = JSON.parse(message.data);
			//console.log(message.data);
			switch (msg["type"]) {
				case "viz_state":
					// Draw in the visualization elements
					for (var e in msg["data"]) {
						txt = msg["data"][e];
						txt = txt.replace(/(?:\r\n|\r|\n)/g, '<br />'); // Replace lin breaks with BR tags
						$("#element_"+e).html(txt); // Replace element text with data
					}
					break;
				case "end":
					control.running = false;
					break;
				default:
					console.log("Unexpected message.");
			}
		}

		var send = function(message) {
			msg = JSON.stringify(message);
			ws.send(msg);
		}

		var reset = function() {
			control.tick = 0;
			control.running = true;
			send({"type": "reset"});
		}

		var step = function() {
			if(control.running) {
				control.tick += 1;
				send({"type": "get_step", "step": control.tick});
			}
		}

		var run = function() {
			player = setInterval(function() {
				if (!control.running) clearInterval(player);
				step();
			}, 1000/control.fps);
		}

		var pause = function() {
			clearInterval(player);
		}
	</script>
	
</head>
<body>
	<script>
	// Set up the GUI
	var gui = new dat.GUI();
	var fps_control = gui.add(control, "fps", 0, 20).step(1);
	gui.add(this, "reset");
	gui.add(this, "step");
	gui.add(this, "run");
	gui.add(this, "pause");

	/**
	Change the frame rate live.
	*/
	fps_control.onFinishChange(function(value) {
		pause();
		run();
	});

	</script>

	<h2>{{ model_name }}</h2>

	<div id="Visualization">
		{% for element in range(element_count) %}
			<div id="element_{{element}}"></div>
		{% end %}
	</div>

</body>